<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Duty Planner - Mon to Fri</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    .container {
      max-width: 500px;
      margin: auto;
    }
    .week {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 20px;
    }
    .day {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    select {
      width: 100%;
      margin-top: 10px;
    }
    .details {
      margin-top: 8px;
      font-size: 14px;
      color: #333;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      margin: 10px 5px 20px 0;
    }
    .summary {
      margin-top: 30px;
      display: none;
    }
    .summary-day {
      margin-bottom: 10px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
    }
    .summary-day strong {
      display: inline-block;
      width: 80px;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>Weekly Duty Planner</h1>

  <label for="weekStart"><strong>Week Commencing (Sunday):</strong></label>
  <input type="date" id="weekStart" />

  <div class="week" id="week"></div>

  <div style="text-align: center;">
    <button id="printBtn" disabled>Print</button>
    <button id="exportBtn" disabled>Export to Calendar</button>
  </div>

  <div class="summary" id="summary">
    <h2>Weekly Duty Summary</h2>
    <div id="summaryContent"></div>
  </div>
</div>

<script>
  const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
  const dutyCodes = [
    { code: '02A/B', station: 'CHI', time: '0700 - 1600' },
    { code: '03A/B', station: 'SSS', time: '0700 - 1600' },
    { code: '04A/B', station: 'HTH', time: '0645 - 1545' },
    { code: '05A/B', station: 'GHD', time: '0630 - 1530' },
    { code: '06A/B/C', station: 'CEN', time: '0630 - 1530' },
    { code: '07A/B', station: 'MMT', time: '0630 - 1530' },
    { code: '08A/B', station: 'SJM', time: '0645 - 1545' },
    { code: '09A/B', station: 'MAN', time: '0645 - 1545' },
    { code: '10A/B', station: 'BYK', time: '0700 - 1600' },
    { code: '11A/B', station: 'NSH', time: '0700 - 1600' },
    { code: '12A/B', station: 'HAY', time: '0630 - 1530' },
    { code: '13A/B', station: 'JES', time: '0645 - 1545' },
    { code: '14', station: 'RGC', time: '0700 - 1600' },
    { code: '15A/B', station: 'APT', time: '0700 - 1600' },
    { code: '16', station: 'PLI', time: '0700 - 1600' },
    { code: '13-0', station: 'HAY', time: '1000 - 1900' },
    { code: '13-1', station: 'MMT', time: '1000 - 1900' },
    { code: '02-0/02-1', station: 'CHI', time: '1500 - 0000' },
    { code: '03-0/03-1', station: 'SSS', time: '1500 - 0000' },
    { code: '04X/Y', station: 'HTH', time: '1500 - 0000' },
    { code: '05-1/05-2', station: 'GHD', time: '1500 - 0000' },
    { code: '06X/Y', station: 'CEN', time: '1500 - 0000' },
    { code: '07X/Y', station: 'MMT', time: '1500 - 0000' },
    { code: '08X/Y', station: 'SJM', time: '1500 - 0000' },
    { code: '09X/Y', station: 'MAN', time: '1500 - 0000' },
    { code: '11-0/11-1', station: 'NSH', time: '1500 - 0000' },
    { code: '12X/Y', station: 'HAY', time: '1500 - 0000' },
    { code: '18', station: 'PLI', time: '1500 - 0000' }
  ];

  const weekContainer = document.getElementById('week');
  const summaryContainer = document.getElementById('summary');
  const summaryContent = document.getElementById('summaryContent');
  const printBtn = document.getElementById('printBtn');
  const exportBtn = document.getElementById('exportBtn');
  const weekStartInput = document.getElementById('weekStart');

  let selectedDuties = {};

  // Create day blocks
  days.forEach(day => {
    const dayDiv = document.createElement('div');
    dayDiv.className = 'day';
    dayDiv.innerHTML = `
      <strong>${day}</strong><br/>
      <select data-day="${day}">
        <option value="">-- Select Duty Code --</option>
        ${dutyCodes.map(d => `<option value="${d.code}">${d.code}</option>`).join('')}
      </select>
      <div class="details" id="details-${day}"></div>
    `;
    weekContainer.appendChild(dayDiv);
  });

  // Validate Week Start (Sunday only)
  function isValidWeekStart(dateStr) {
    const date = new Date(dateStr);
    return date.getDay() === 0;
  }

  // Validate button state
  function updateButtons() {
    const validCount = Object.keys(selectedDuties).length === 4;
    const weekSelected = weekStartInput.value && isValidWeekStart(weekStartInput.value);
    printBtn.disabled = !(validCount && weekSelected);
    exportBtn.disabled = !(validCount && weekSelected);
  }

  // Handle dropdowns
  weekContainer.addEventListener('change', (e) => {
    if (e.target.tagName === 'SELECT') {
      const day = e.target.dataset.day;
      const code = e.target.value;
      const detailDiv = document.getElementById(`details-${day}`);

      if (code) {
        const duty = dutyCodes.find(d => d.code === code);
        selectedDuties[day] = code;
        detailDiv.textContent = `${duty.station} - ${duty.time}`;
      } else {
        delete selectedDuties[day];
        detailDiv.textContent = '';
      }

      updateButtons();
    }
  });

  // Week start date
  weekStartInput.addEventListener('change', () => {
    if (!isValidWeekStart(weekStartInput.value)) {
      alert("Week Commencing must be a Sunday.");
      weekStartInput.value = '';
    }
    updateButtons();
  });

  // Parse start/end times into Date objects
  function parseDutyTime(timeStr, offset) {
    const weekStart = new Date(weekStartInput.value);
    const dayDate = new Date(weekStart);
    dayDate.setDate(weekStart.getDate() + offset);

    const [startStr, endStr] = timeStr.split(' - ');
    const [sh, sm] = startStr.match(/.{1,2}/g).map(Number);
    const [eh, em] = endStr.match(/.{1,2}/g).map(Number);

    const startDate = new Date(dayDate);
    startDate.setHours(sh, sm, 0);

    const endDate = new Date(startDate);
    endDate.setHours(eh, em, 0);
    if (endDate <= startDate) endDate.setDate(endDate.getDate() + 1); // Overnight

    return [startDate, endDate];
  }

  // Format to ICS UTC
  const toICSDate = d => d.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';

  // Print
  printBtn.addEventListener('click', () => {
    summaryContent.innerHTML = '';
    days.forEach(day => {
      const code = selectedDuties[day];
      const duty = dutyCodes.find(d => d.code === code);
      const div = document.createElement('div');
      div.className = 'summary-day';
      if (duty) {
        div.innerHTML = `<strong>${day}:</strong> ${duty.code} = ${duty.station} - ${duty.time}`;
      } else {
        div.innerHTML = `<strong>${day}:</strong> RD`;
      }
      summaryContent.appendChild(div);
    });
    summaryContainer.style.display = 'block';
    window.print();
  });

  // Export ICS
  exportBtn.addEventListener('click', () => {
    let ics = `BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//DutyPlanner//EN\n`;

    Object.entries(selectedDuties).forEach(([day, code]) => {
      const duty = dutyCodes.find(d => d.code === code);
      const offset = days.indexOf(day);
      const [start, end] = parseDutyTime(duty.time, offset);
      ics += `BEGIN:VEVENT\nSUMMARY:${duty.code} = ${duty.station}\n`;
      ics += `DTSTART:${toICSDate(start)}\n`;
      ics += `DTEND:${toICSDate(end)}\n`;
      ics += `LOCATION:${duty.station}\n`;
      ics += `DESCRIPTION:${duty.code} - ${duty.time}\nEND:VEVENT\n`;
    });

    ics += 'END:VCALENDAR';

    const blob = new Blob([ics], { type: 'text/calendar' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'weekly_duties.ics';
    a.click();
    URL.revokeObjectURL(url);
  });
</script>

</body>
</html>
