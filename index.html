<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Duty Planner - Mon to Fri</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    .week {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .day {
      flex: 1;
      min-width: 140px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      text-align: center;
    }
    select {
      width: 100%;
      margin-top: 10px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      margin: 10px 5px 20px 0;
    }
    .summary {
      margin-top: 30px;
      display: none;
    }
    .summary-day {
      margin-bottom: 10px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
    }
    .summary-day strong {
      display: inline-block;
      width: 80px;
    }
  </style>
</head>
<body>

<h1>Weekly Duty Planner</h1>

<div class="week" id="week"></div>

<button id="printBtn" disabled>Print</button>
<button id="exportBtn" disabled>Export to Calendar</button>

<div class="summary" id="summary">
  <h2>Weekly Duty Summary</h2>
  <div id="summaryContent"></div>
</div>

<script>
  const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];

  const dutyCodes = [
    // Early Duties
    { code: '02A/B', station: 'CHI', time: '0700 - 1600' },
    { code: '03A/B', station: 'SSS', time: '0700 - 1600' },
    { code: '04A/B', station: 'HTH', time: '0645 - 1545' },
    { code: '05A/B', station: 'GHD', time: '0630 - 1530' },
    { code: '06A/B/C', station: 'CEN', time: '0630 - 1530' },
    { code: '07A/B', station: 'MMT', time: '0630 - 1530' },
    { code: '08A/B', station: 'SJM', time: '0645 - 1545' },
    { code: '09A/B', station: 'MAN', time: '0645 - 1545' },
    { code: '10A/B', station: 'BYK', time: '0700 - 1600' },
    { code: '11A/B', station: 'NSH', time: '0700 - 1600' },
    { code: '12A/B', station: 'HAY', time: '0630 - 1530' },
    { code: '13A/B', station: 'JES', time: '0645 - 1545' },
    { code: '14', station: 'RGC', time: '0700 - 1600' },
    { code: '15A/B', station: 'APT', time: '0700 - 1600' },
    { code: '16', station: 'PLI', time: '0700 - 1600' },

    // Mid Duties
    { code: '13-0', station: 'HAY', time: '1000 - 1900' },
    { code: '13-1', station: 'MMT', time: '1000 - 1900' },

    // Late Duties
    { code: '02-0/02-1', station: 'CHI', time: '1500 - 0000' },
    { code: '03-0/03-1', station: 'SSS', time: '1500 - 0000' },
    { code: '04X/Y', station: 'HTH', time: '1500 - 0000' },
    { code: '05-1/05-2', station: 'GHD', time: '1500 - 0000' },
    { code: '06X/Y', station: 'CEN', time: '1500 - 0000' },
    { code: '07X/Y', station: 'MMT', time: '1500 - 0000' },
    { code: '08X/Y', station: 'SJM', time: '1500 - 0000' },
    { code: '09X/Y', station: 'MAN', time: '1500 - 0000' },
    { code: '11-0/11-1', station: 'NSH', time: '1500 - 0000' },
    { code: '12X/Y', station: 'HAY', time: '1500 - 0000' },
    { code: '18', station: 'PLI', time: '1500 - 0000' }
  ];

  const weekContainer = document.getElementById('week');
  const summaryContainer = document.getElementById('summary');
  const summaryContent = document.getElementById('summaryContent');
  const printBtn = document.getElementById('printBtn');
  const exportBtn = document.getElementById('exportBtn');

  let selectedDuties = {};

  // Render each day
  days.forEach(day => {
    const dayDiv = document.createElement('div');
    dayDiv.className = 'day';
    dayDiv.innerHTML = `<strong>${day}</strong><br/>
      <select data-day="${day}">
        <option value="">-- Select Duty --</option>
        ${dutyCodes.map(d =>
          `<option value="${d.code}">${d.code} = ${d.station} - ${d.time.replace(' - ', ' until ')}</option>`
        ).join('')}
      </select>`;
    weekContainer.appendChild(dayDiv);
  });

  // Handle selection
  weekContainer.addEventListener('change', (e) => {
    if (e.target.tagName === 'SELECT') {
      const day = e.target.dataset.day;
      const code = e.target.value;

      if (code) {
        selectedDuties[day] = code;
      } else {
        delete selectedDuties[day];
      }

      const valid = Object.keys(selectedDuties).length === 4;
      printBtn.disabled = !valid;
      exportBtn.disabled = !valid;
    }
  });

  // Print
  printBtn.addEventListener('click', () => {
    summaryContent.innerHTML = '';
    days.forEach(day => {
      const code = selectedDuties[day];
      const detail = dutyCodes.find(d => d.code === code);
      const dayDiv = document.createElement('div');
      dayDiv.className = 'summary-day';
      if (detail) {
        dayDiv.innerHTML = `<strong>${day}:</strong> ${detail.code} = ${detail.station} - ${detail.time.replace(' - ', ' until ')}`;
      } else {
        dayDiv.innerHTML = `<strong>${day}:</strong> RD`;
      }
      summaryContent.appendChild(dayDiv);
    });
    summaryContainer.style.display = 'block';
    window.print();
  });

  // Helper to parse time into Date
  function parseDutyTime(timeStr, dayOffset) {
    const [startStr, endStr] = timeStr.split(' - ');
    const today = new Date();
    const startDate = new Date(today);
    startDate.setDate(startDate.getDate() - startDate.getDay() + 1 + dayOffset);
    const [sh, sm] = startStr.split(':').map(Number);
    startDate.setHours(sh, sm, 0);

    const endDate = new Date(startDate);
    const [eh, em] = endStr.split(':').map(Number);
    endDate.setHours(eh, em, 0);

    if (endDate <= startDate) {
      endDate.setDate(endDate.getDate() + 1); // Overnight
    }

    return [startDate, endDate];
  }

  // Export to calendar
  exportBtn.addEventListener('click', () => {
    let icsContent = `BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//DutyPlanner//EN\n`;

    Object.entries(selectedDuties).forEach(([day, code]) => {
      const duty = dutyCodes.find(d => d.code === code);
      const dayIndex = days.indexOf(day);
      const [start, end] = parseDutyTime(duty.time, dayIndex);

      const toICSDate = date =>
        date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';

      icsContent += `BEGIN:VEVENT\nSUMMARY:${duty.code} = ${duty.station}\n`;
      icsContent += `DTSTART:${toICSDate(start)}\n`;
      icsContent += `DTEND:${toICSDate(end)}\n`;
      icsContent += `LOCATION:${duty.station}\n`;
      icsContent += `DESCRIPTION:${duty.code} - ${duty.time}\n`;
      icsContent += `END:VEVENT\n`;
    });

    icsContent += 'END:VCALENDAR';

    const blob = new Blob([icsContent], { type: 'text/calendar' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'weekly_duties.ics';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });
</script>

</body>
</html>
